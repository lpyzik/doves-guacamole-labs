version: "3.9"

# =========================
# NETWORKS
# =========================
networks:
  doves:
    driver: bridge
  guacnet:
    driver: bridge

# =========================
# VOLUMES
# =========================
volumes:
  postgres_data:
  doves_data:
  guacd_drive:
  guacd_record:

# =========================
# SERVICES
# =========================
services:

  # =========================
  # FRONTEND (DoVEs React)
  # =========================
  frontend:
    build:
      context: ./doves/doves-frontend
      args:
        REACT_APP_DOVES_API_URL: ${REACT_APP_DOVES_API_URL}
    restart: unless-stopped
    networks:
      - doves

  # =========================
  # BACKEND (DoVEs API)
  # =========================
  backend:
    build:
      context: ./doves/DoVEs-backend
    restart: unless-stopped
    depends_on:
      - db
    volumes:
      # klucz SSH tylko do odczytu
      - ${DOCKER_CUSTOM_VOLUME}:${DOCKER_SSH_KEY}:ro
    environment:
      MONGO_URI: mongodb://db:27017/doves

      DOCKER_VIA: ssh
      DOCKER_SSH_HOST: ${DOCKER_SSH_HOST}
      DOCKER_SSH_USER: ${DOCKER_SSH_USER}
      DOCKER_SSH_KEY: ${DOCKER_SSH_KEY}

      LAB_PATH: ${LAB_PATH}
      DOCKER_COMPOSE_CREATE_SCRIPT: ${DOCKER_COMPOSE_CREATE_SCRIPT}
      DOCKER_COMPOSE_TEAR_DOWN_SCRIPT: ${DOCKER_COMPOSE_TEAR_DOWN_SCRIPT}
      DOCKER_COMPOSE_REBUILD_MACHINE_SCRIPT: ${DOCKER_COMPOSE_REBUILD_MACHINE_SCRIPT}

      LP_DEFAULT_PASSWORD: ${PASSWORD}
    networks:
      - doves

  # =========================
  # MONGODB (DoVEs)
  # =========================
  db:
    image: mongo:7
    restart: unless-stopped
    volumes:
      - doves_data:/data/db
    networks:
      - doves

  # =========================
  # REVERSE PROXY (nginx)
  # =========================
  proxy:
    build:
      context: ./doves/proxy
      args:
        USERNAME: ${USERNAME}
        PASSWORD: ${PASSWORD}
    restart: unless-stopped
    depends_on:
      - frontend
      - backend
      - guacamole
    ports:
      - "8080:80"
    networks:
      - doves

  # =========================
  # GUACD (Guacamole daemon)
  # =========================
  guacd:
    image: guacamole/guacd
    restart: unless-stopped
    volumes:
      - guacd_drive:/drive
      - guacd_record:/record
    networks:
      - guacnet

  # =========================
  # POSTGRESQL (Guacamole DB)
  # =========================
  postgres:
    image: postgres:17
    restart: unless-stopped
    environment:
      POSTGRES_DB: guacamole_db
      POSTGRES_USER: guacamole
      POSTGRES_PASSWORD: guacamole
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - guacnet

  # =========================
  # GUACAMOLE WEB
  # =========================
  guacamole:
    image: guacamole/guacamole
    restart: unless-stopped
    depends_on:
      - postgres
      - guacd
    environment:
      GUACD_HOSTNAME: guacd
      GUACD_PORT: 4822

      POSTGRESQL_HOSTNAME: postgres
      POSTGRESQL_DATABASE: guacamole_db
      POSTGRESQL_USERNAME: guacamole
      POSTGRESQL_PASSWORD: guacamole
    # port 8181 opcjonalny (do debugowania)
    ports:
      - "8181:8080"
    networks:
      - guacnet
      - doves



 

